name: Deploy

on:
  push:
    branches: [main]
    paths-ignore:
      - '**.md'
      - '.gitignore'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production

jobs:
  deploy:
    name: Deploy to Server
    runs-on: linux
    steps:
      - name: Checkout code
        run: |
          SERVER_HOST=$(echo "${{ github.server_url }}" | sed 's|https://||' | sed 's|http://||')
          git clone --depth 1 --branch ${{ github.ref_name }} http://oauth2:${{ secrets.GITHUB_TOKEN }}@${SERVER_HOST}/${{ github.repository }}.git .

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

      - name: Deploy via SSH
        env:
          SSH_HOST: ${{ secrets.DEPLOY_HOST }}
          SSH_USER: ${{ secrets.DEPLOY_USER }}
          SSH_PORT: ${{ secrets.DEPLOY_SSH_PORT || '22' }}
          DEPLOY_PATH: ${{ vars.DEPLOY_PATH }}
          POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
          POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
          API_PORT: ${{ vars.API_PORT || '3001' }}
          WEB_PORT: ${{ vars.WEB_PORT || '3000' }}
        run: |
          ssh -i ~/.ssh/deploy_key -p ${SSH_PORT:-22} -o StrictHostKeyChecking=no -o BatchMode=yes ${SSH_USER}@${SSH_HOST} << DEPLOY_SCRIPT
          set -e
          echo "üöÄ Starting deployment..."
          
          # Navigate to project directory
          cd ${DEPLOY_PATH}
          
          # Pull latest code
          echo "‚¨áÔ∏è Pulling latest code..."
          git pull origin main
          
          # Backup database
          echo "üì¶ Creating database backup..."
          docker compose -f docker-compose.prod.yml exec -T db pg_dump -U ${POSTGRES_USER} ${POSTGRES_DB} > backup_\$(date +%Y%m%d_%H%M%S).sql 2>/dev/null || echo "No existing DB to backup"
          
          # Build and restart services
          echo "üî® Building and restarting services..."
          docker compose -f docker-compose.prod.yml up -d --build --force-recreate
          
          # Wait for services to start
          echo "‚è≥ Waiting for services..."
          sleep 20
          
          # Run database migrations
          echo "üîÑ Running migrations..."
          docker compose -f docker-compose.prod.yml exec -T api npx prisma migrate deploy || echo "Migration skipped"
          
          # Health checks
          echo "üè• Running health checks..."
          
          if curl -sf http://localhost:${API_PORT:-3001}/health > /dev/null 2>&1 || curl -sf http://localhost:${API_PORT:-3001}/ > /dev/null 2>&1; then
            echo "‚úÖ API is healthy"
          else
            echo "‚ö†Ô∏è API check inconclusive, checking logs..."
            docker compose -f docker-compose.prod.yml logs --tail=20 api
          fi
          
          if curl -sf http://localhost:${WEB_PORT:-3000}/ > /dev/null 2>&1; then
            echo "‚úÖ Web is healthy"
          else
            echo "‚ö†Ô∏è Web check inconclusive, checking logs..."
            docker compose -f docker-compose.prod.yml logs --tail=20 web
          fi
          
          # Cleanup
          echo "üßπ Cleaning up old images..."
          docker image prune -f
          
          # Keep only last 5 backups
          ls -t backup_*.sql 2>/dev/null | tail -n +6 | xargs -r rm
          
          echo "‚úÖ Deployment complete!"
          DEPLOY_SCRIPT

      - name: Notify Discord - Success
        if: success() && vars.DISCORD_WEBHOOK_URL != ''
        run: |
          curl -H "Content-Type: application/json" \
            -d '{"embeds": [{"title": "‚úÖ D√©ploiement r√©ussi", "color": 5763719, "description": "Cloud Proxmox d√©ploy√© avec succ√®s", "footer": {"text": "Commit: ${{ github.sha }}"}}]}' \
            ${{ vars.DISCORD_WEBHOOK_URL }} || true

      - name: Notify Discord - Failure
        if: failure() && vars.DISCORD_WEBHOOK_URL != ''
        run: |
          curl -H "Content-Type: application/json" \
            -d '{"embeds": [{"title": "‚ùå D√©ploiement √©chou√©", "color": 15548997, "description": "V√©rifiez les logs GitHub Actions", "footer": {"text": "Commit: ${{ github.sha }}"}}]}' \
            ${{ vars.DISCORD_WEBHOOK_URL }} || true
